

<!doctype html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>1.3.2. Building the CLM tools &#8212; clmdoc release-clm5.0.01 documentation</title>
    <link rel="stylesheet" href="../../_static/bizstyle.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     'release-clm5.0.01',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: '.txt'
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="1.3.3. Creating input for surface dataset generation" href="creating-input-for-surface-dataset-generation.html" />
    <link rel="prev" title="1.3.1. What are the CLM tools" href="what-are-the-clm-tools.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0">
    <!--[if lt IE 9]>
    <script type="text/javascript" src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="creating-input-for-surface-dataset-generation.html" title="1.3.3. Creating input for surface dataset generation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="what-are-the-clm-tools.html" title="1.3.1. What are the CLM tools"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">clmdoc release-clm5.0.01 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >1. clm5.0 User’s Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" accesskey="U">1.3. Using CLM tools</a> &#187;</li> 
      </ul>
    </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h4>Previous topic</h4>
  <p class="topless"><a href="what-are-the-clm-tools.html"
                        title="previous chapter">1.3.1. What are the CLM tools</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="creating-input-for-surface-dataset-generation.html"
                        title="next chapter">1.3.3. Creating input for surface dataset generation</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../../_sources/users_guide/using-clm-tools/building-the-clm-tools.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="building-the-clm-tools">
<h1>1.3.2. Building the CLM tools<a class="headerlink" href="#building-the-clm-tools" title="Permalink to this headline">¶</a></h1>
<p>The FORTRAN tools all have similar makefiles, and similar options for building.
All of the Makefiles use GNU Make extensions and thus require that you use GNU make to use them.
They also auto detect the type of platform you are on, using “uname -s” and set the compiler, compiler flags and such accordingly.
There are also environment variables that can be set to set things that must be customized.
All the tools use NetCDF and hence require the path to the NetCDF libraries and include files.
On some platforms (such as Linux) multiple compilers can be used, and hence there are env variables that can be set to change the FORTRAN and/or “C” compilers used.
The tools other than cprnc also allow finer control, by also allowing the user to add compiler flags they choose, for both FORTRAN and “C”, as well as picking the compiler, linker and and add linker options.
Finally the tools other than <strong>cprnc</strong> allow you to turn optimization on (which is off by default but on for the <strong>mksurfdata_map</strong> and <strong>interpinic</strong> programs) with the OPT flag so that the tool will run faster.
To get even faster performance, the <strong>interpinic</strong>, program allows you to also use the SMP to turn on multiple shared memory processors.
When <code class="docutils literal"><span class="pre">SMP=TRUE</span></code> you set the number of threads used by the program with the <code class="docutils literal"><span class="pre">OMP_NUM_THREADS</span></code> environment variable.</p>
<p>Options used by all: <strong>cprnc</strong>, <strong>interpinic</strong>, and <strong>mksurfdata_map</strong></p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">LIB_NETCDF</span></code> – sets the location of the NetCDF library.</li>
<li><code class="docutils literal"><span class="pre">INC_NETCDF</span></code> – sets the location of the NetCDF include files.</li>
<li><code class="docutils literal"><span class="pre">USER_FC</span></code> – sets the name of the FORTRAN compiler.</li>
</ul>
<p>Options used by: <strong>interpinic</strong>, <strong>mkprocdata_map</strong>, <strong>mkmapgrids</strong>, and <strong>mksurfdata_map</strong></p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">MOD_NETCDF</span></code> – sets the location of the NetCDF FORTRAN module.</li>
<li><code class="docutils literal"><span class="pre">USER_LINKER</span></code> – sets the name of the linker to use.</li>
<li><code class="docutils literal"><span class="pre">USER_CPPDEFS</span></code> – adds any CPP defines to use.</li>
<li><code class="docutils literal"><span class="pre">USER_CFLAGS</span></code> – add any “C” compiler flags to use.</li>
<li><code class="docutils literal"><span class="pre">USER_FFLAGS</span></code> – add any FORTRAN compiler flags to use.</li>
<li><code class="docutils literal"><span class="pre">USER_LDFLAGS</span></code> – add any linker flags to use.</li>
<li><code class="docutils literal"><span class="pre">USER_CC</span></code> – sets the name of the “C” compiler to use.</li>
<li><code class="docutils literal"><span class="pre">OPT</span></code> – set to TRUE to compile the code optimized (TRUE or FALSE)</li>
<li><code class="docutils literal"><span class="pre">SMP</span></code> – set to TRUE to turn on shared memory parallelism (i.e. OpenMP) (TRUE or FALSE)</li>
<li><code class="docutils literal"><span class="pre">Filepath</span></code> – list of directories to build source code from.</li>
<li><code class="docutils literal"><span class="pre">Srcfiles</span></code> – list of source code filenames to build executable from.</li>
<li><code class="docutils literal"><span class="pre">Makefile</span></code> – customized makefile options for this particular tool.</li>
<li><code class="docutils literal"><span class="pre">mkDepends</span></code> – figure out dependencies between source files, so make can compile in order..</li>
<li><code class="docutils literal"><span class="pre">Makefile.common</span></code> – General tool Makefile that should be the same between all tools.</li>
</ul>
<p>Options used only by <strong>cprnc</strong>:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">EXEDIR</span></code> – sets the location where the executable will be built.</li>
<li><code class="docutils literal"><span class="pre">VPATH</span></code> – colon delimited path list to find the source files.</li>
</ul>
<p>More details on each environment variable.</p>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">LIB_NETCDF</span></code></dt>
<dd>This variable sets the path to the NetCDF library file (<code class="docutils literal"><span class="pre">libnetcdf.a</span></code>). If not set it defaults to <code class="docutils literal"><span class="pre">/usr/local/lib</span></code>. In order to use the tools you need to build the NetCDF library and be able to link to it. In order to build the model with a particular compiler you may have to compile the NetCDF library with the same compiler (or at least a compatible one).</dd>
<dt><code class="docutils literal"><span class="pre">INC_NETCDF</span></code></dt>
<dd>This variable sets the path to the NetCDF include directory (in order to find the include file <code class="docutils literal"><span class="pre">netcdf.inc</span></code>). if not set it defaults to <code class="docutils literal"><span class="pre">/usr/local/include</span></code>.</dd>
<dt><code class="docutils literal"><span class="pre">MOD_NETCDF</span></code></dt>
<dd>This variable sets the path to the NetCDF module directory (in order to find the NetCDF FORTRAN-90 module file when NetCDF is used with a FORTRAN-90 <strong>use statement</strong>. When not set it defaults to the <code class="docutils literal"><span class="pre">LIB_NETCDF</span></code> value.</dd>
<dt><code class="docutils literal"><span class="pre">USER_FC</span></code></dt>
<dd>This variable sets the command name to the FORTRAN-90 compiler to use when compiling the tool. The default compiler to use depends on the platform. And for example, on the AIX platform this variable is NOT used</dd>
<dt><code class="docutils literal"><span class="pre">USER_LINKER</span></code></dt>
<dd>This variable sets the command name to the linker to use when linking the object files from the compiler together to build the executable. By default this is set to the value of the FORTRAN-90 compiler used to compile the source code.</dd>
<dt><code class="docutils literal"><span class="pre">USER_CPPDEFS</span></code></dt>
<dd>This variable adds additional optional values to define for the C preprocessor. Normally, there is no reason to do this as there are very few CPP tokens in the CLM tools. However, if you modify the tools there may be a reason to define new CPP tokens.</dd>
<dt><code class="docutils literal"><span class="pre">USER_CC</span></code></dt>
<dd>This variable sets the command name to the “C” compiler to use when compiling the tool. The default compiler to use depends on the platform. And for example, on the AIX platform this variable is NOT used</dd>
<dt><code class="docutils literal"><span class="pre">USER_CFLAGS</span></code></dt>
<dd>This variable adds additional compiler options for the “C” compiler to use when compiling the tool. By default the compiler options are picked according to the platform and compiler that will be used.</dd>
<dt><code class="docutils literal"><span class="pre">USER_FFLAGS</span></code></dt>
<dd>This variable adds additional compiler options for the FORTRAN-90 compiler to use when compiling the tool. By default the compiler options are picked according to the platform and compiler that will be used.</dd>
<dt><code class="docutils literal"><span class="pre">USER_LDFLAGS</span></code></dt>
<dd>This variable adds additional options to the linker that will be used when linking the object files into the executable. By default the linker options are picked according to the platform and compiler that is used.</dd>
<dt><code class="docutils literal"><span class="pre">SMP</span></code></dt>
<dd>This variable flags if shared memory parallelism (using OpenMP) should be used when compiling the tool. It can be set to either TRUE or FALSE, by default it is set to FALSE, so shared memory parallelism is NOT used. When set to TRUE you can set the number of threads by using the OMP_NUM_THREADS environment variable. Normally, the most you would set this to would be to the number of on-node CPU processors. Turning this on should make the tool run much faster.</dd>
</dl>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note, that depending on the compiler answers may be different when SMP is activated.</p>
</div>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">OPT</span></code></dt>
<dd>This variable flags if compiler optimization should be used when compiling the tool. It can be set to either <code class="docutils literal"><span class="pre">TRUE</span></code> or <code class="docutils literal"><span class="pre">FALSE</span></code>, by default it is set to <code class="docutils literal"><span class="pre">FALSE</span></code> for <strong>mkmapgrids</strong> and <code class="docutils literal"><span class="pre">TRUE</span></code> for <strong>mksurfdata_map</strong>, <strong>mkprocdata_map</strong> and <strong>interpinic</strong>. Turning this on should make the tool run much faster.</dd>
</dl>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Note, you should expect that answers will be different when <code class="docutils literal"><span class="pre">OPT</span></code> is activated.</p>
</div>
<dl class="docutils">
<dt><code class="docutils literal"><span class="pre">Filepath</span></code></dt>
<dd>All of the tools are stand-alone and don’t need any outside code to operate. The Filepath is the list of directories needed to compile and hence is always simply “.” the current directory. Several tools use copies of code outside their directory that is in the CESM distribution (either <code class="docutils literal"><span class="pre">csm_share</span></code> code or CLM source code).</dd>
<dt><code class="docutils literal"><span class="pre">Srcfiles</span></code></dt>
<dd>The <code class="docutils literal"><span class="pre">Srcfiles</span></code> lists the filenames of the source code to use when building the tool.</dd>
<dt><code class="docutils literal"><span class="pre">Makefile</span></code></dt>
<dd>The <code class="docutils literal"><span class="pre">Makefile</span></code> is the custom GNU Makefile for this particular tool. It will customize the <code class="docutils literal"><span class="pre">EXENAME</span></code> and the optimization settings for this particular tool.</dd>
<dt><code class="docutils literal"><span class="pre">Makefile.common</span></code></dt>
<dd>The <code class="docutils literal"><span class="pre">Makefile.common</span></code> is the copy of the general GNU Makefile for all the CLM tools. This file should be identical between the different tools. This file has different sections of compiler options for different Operating Systems and compilers.</dd>
<dt><code class="docutils literal"><span class="pre">mkDepends</span></code></dt>
<dd>The <code class="docutils literal"><span class="pre">mkDepends</span></code> is the copy of the perl script used by the <code class="docutils literal"><span class="pre">Makefile.common</span></code> to figure out the dependencies between the source files so that it can compile in the necessary order. This file should be identical between the different tools.</dd>
<dt><code class="docutils literal"><span class="pre">EXEDIR</span></code></dt>
<dd>The cprnc tool uses this variable to set the location of where the executable will be built. The default is the current directory.</dd>
<dt><code class="docutils literal"><span class="pre">VPATH</span></code></dt>
<dd>The <strong>cprnc</strong> tool uses this variable to set the colon delimited pathnames of where the source code exists. The default is the current directory.</dd>
</dl>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">There are several files that are copies of the original files from either models``/lnd/clm/src/util_share``, <code class="docutils literal"><span class="pre">models/csm_share/shr</span></code>, or copies from other tool directories. By having copies the tools can all be made stand-alone, but any changes to the originals will have to be put into the tool directories as well.</p>
</div>
<p>The <em>README.filecopies</em> (which can be found in <code class="docutils literal"><span class="pre">$CTSMROOT/tools</span></code>) is repeated here.</p>
<pre class="literal-block">
tools/README.filecopies                       May/26/2011

There are several files that are copies of the original files from
either CTSM src/main, cime/src/share/utils,
cime/src/share/unit_test_stubs, or copies from other tool
directories. By having copies the tools can all be made stand-alone,
but any changes to the originals will have to be put into the tool
directories as well.

I. Files that are IDENTICAL:

   1. csm_share files copied that should be identical to cime/share/utils:

       shr_kind_mod.F90
       shr_const_mod.F90
       shr_log_mod.F90
       shr_timer_mod.F90
       shr_string_mod.F90
       shr_file_mod.F90
       
   2. csm_share files copied that should be identical to cime/share/csm_share/unit_testers:

       test_mod.F90

II. Files with differences

   1. csm_share files copied with differences:

       shr_sys_mod.F90 - Remove mpi abort and reference to shr_mpi_mod.F90.

   2. CTSM src/utils files with differences:

       fileutils.F90 --- Remove use of masterproc and spmdMod and endrun in abortutils.

   3. Files in mksurfdata_map

       mkvarpar.F90
       nanMod.F90

</pre>
</div>


          </div>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="creating-input-for-surface-dataset-generation.html" title="1.3.3. Creating input for surface dataset generation"
             >next</a> |</li>
        <li class="right" >
          <a href="what-are-the-clm-tools.html" title="1.3.1. What are the CLM tools"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">clmdoc release-clm5.0.01 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >1. clm5.0 User’s Guide</a> &#187;</li>
          <li class="nav-item nav-item-2"><a href="index.html" >1.3. Using CLM tools</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2017, Erik Kluzek, Bill Sacks, Ben Andre.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.6.3.
    </div>
  </body>
</html>